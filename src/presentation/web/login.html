<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GDrive Slack Notifier - Login</title>
  <!-- Unified Authentication Styles -->
  <?!= include('auth-styles.html'); ?>
</head>

<body>
  <div class="auth-container">
    <div class="logo">
      <h1>üîî GDrive Slack Notifier</h1>
      <p>Secure access to your notification system</p>
    </div>

    <div class="auth-tabs">
      <button class="tab-button active" onclick="switchTab('sso')">SSO Login</button>
      <button class="tab-button" onclick="switchTab('manual')">Manual Login</button>
    </div>

    <!-- SSO Login Form -->
    <div id="sso-form" class="auth-form active">
      <div class="info-box">
        <h4>üîê Google Workspace SSO</h4>
        <p>Sign in with your Google Workspace account for instant access.</p>
      </div>

      <div class="form-group">
        <label for="sso-email">Email Address</label>
        <input type="email" id="sso-email" placeholder="your.email@company.com" required>
        <div class="domain-info" id="sso-domain-info">
          ‚úÖ This domain is approved for SSO access
        </div>
      </div>

      <button class="auth-button" onclick="handleSSOLogin()">
                Sign in with Google
            </button>

      <div class="loading" id="sso-loading">
        <div class="spinner"></div>
        <p>Authenticating with Google...</p>
      </div>

      <div class="success-message" id="sso-success">
        ‚úÖ SSO authentication successful! Redirecting...
      </div>
    </div>

    <!-- Manual Login Form -->
    <div id="manual-form" class="auth-form">
      <div class="info-box">
        <h4>üë§ Manual Login</h4>
        <p>Sign in with your registered account credentials.</p>
      </div>

      <div class="form-group">
        <label for="manual-email">Email Address</label>
        <input type="email" id="manual-email" placeholder="your.email@example.com" required>
        <div class="error-message" id="manual-email-error"></div>
      </div>

      <div class="form-group">
        <label for="manual-password">Password</label>
        <input type="password" id="manual-password" placeholder="Enter your password" required>
        <div class="error-message" id="manual-password-error"></div>
      </div>

      <button class="auth-button" onclick="handleManualLogin()">
                Sign In
            </button>

      <div class="loading" id="manual-loading">
        <div class="spinner"></div>
        <p>Authenticating...</p>
      </div>

      <div class="success-message" id="manual-success">
        ‚úÖ Manual authentication successful! Redirecting...
      </div>
    </div>

    <div class="footer-links">
      <a href="#" onclick="showRegisterForm()">Need an account?</a>
      <a href="#" onclick="showHelp()">Help & Support</a>
    </div>
  </div>

  <script>
// Global state
let currentTab = 'sso';
let isAuthenticating = false;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    checkExistingAuth();
});

function initializePage() {
    // Add input event listeners
    document.getElementById('sso-email').addEventListener('input', handleSSOEmailChange);
    document.getElementById('manual-email').addEventListener('input', clearErrors);
    document.getElementById('manual-password').addEventListener('input', clearErrors);

    // Add enter key support
    document.getElementById('sso-email').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleSSOLogin();
    });

    document.getElementById('manual-email').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleManualLogin();
    });

    document.getElementById('manual-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleManualLogin();
    });
}

function switchTab(tab) {
    if (isAuthenticating) return;

    currentTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Update forms
    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
    document.getElementById(tab + '-form').classList.add('active');

    clearAllMessages();
}

function handleSSOEmailChange() {
    const email = document.getElementById('sso-email').value;
    const domainInfo = document.getElementById('sso-domain-info');
    
    if (email && email.includes('@')) {
        const domain = email.split('@')[1];
        checkDomainApproval(domain).then(isApproved => {
            if (isApproved) {
                domainInfo.textContent = '‚úÖ This domain is approved for SSO access';
                domainInfo.classList.add('show');
            } else {
                domainInfo.textContent = '‚ö†Ô∏è This domain requires manual registration';
                domainInfo.classList.add('show');
            }
        });
    } else {
        domainInfo.classList.remove('show');
    }
}

async function checkDomainApproval(domain) {
    try {
        const approvedDomains = ['iress.com', 'iress.au', 'company.com'];
        return approvedDomains.includes(domain.toLowerCase());
    } catch (error) {
        console.error('Domain check failed:', error);
        return false;
    }
}

function handleSSOLogin() {
    if (isAuthenticating) return;

    const email = document.getElementById('sso-email').value.trim();
    
    if (!email || !email.includes('@')) {
        showError('sso-email', 'Please enter a valid email address');
        return;
    }

    isAuthenticating = true;
    showLoading('sso');

    const domain = email.split('@')[1];
    
    google.script.run
        .withSuccessHandler(handleAuthSuccess)
        .withFailureHandler(handleAuthError)
        .authenticateUser(email, domain);
}

function handleManualLogin() {
    if (isAuthenticating) return;

    const email = document.getElementById('manual-email').value.trim();
    const password = document.getElementById('manual-password').value;

    if (!email || !email.includes('@')) {
        showError('manual-email', 'Please enter a valid email address');
        return;
    }

    if (!password) {
        showError('manual-password', 'Please enter your password');
        return;
    }

    isAuthenticating = true;
    showLoading('manual');

    google.script.run
        .withSuccessHandler(handleAuthSuccess)
        .withFailureHandler(handleAuthError)
        .authenticateUser(email, email.split('@')[1], { password: password });
}

function handleAuthSuccess(result) {
    isAuthenticating = false;
    hideLoading(currentTab);
    
    console.log('Auth result:', result);
    
    if (!result || !result.success) {
        showError(currentTab + '-email', result?.message || 'Authentication failed');
        return;
    }
    
    showSuccess(currentTab);
    
    const sessionToken = result.session?.sessionId || result.sessionId || result.sessionToken;
    sessionStorage.setItem('authToken', sessionToken);
    sessionStorage.setItem('userEmail', result.user.email);
    sessionStorage.setItem('userRole', result.user.role);
    
    console.log('Stored auth token:', sessionToken);
    console.log('Redirecting to dashboard...');
    
    // Use relative path - works with both /dev and /exec
    setTimeout(function() {
        window.location.replace('?v=dashboard');
    }, 300);
}

function handleAuthError(error) {
    isAuthenticating = false;
    hideLoading(currentTab);
    showError(currentTab + '-email', error.message || 'Authentication failed. Please try again.');
}

function showLoading(formType) {
    document.getElementById(formType + '-loading').classList.add('show');
    document.querySelector('#' + formType + '-form .auth-button').disabled = true;
}

function hideLoading(formType) {
    document.getElementById(formType + '-loading').classList.remove('show');
    document.querySelector('#' + formType + '-form .auth-button').disabled = false;
}

function showSuccess(formType) {
    document.getElementById(formType + '-success').classList.add('show');
}

function showError(fieldId, message) {
    const errorElement = document.getElementById(fieldId + '-error');
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.add('show');
        document.getElementById(fieldId).classList.add('error');
    }
}

function clearErrors() {
    document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
    document.querySelectorAll('input').forEach(el => el.classList.remove('error'));
}

function clearAllMessages() {
    clearErrors();
    document.querySelectorAll('.success-message').forEach(el => el.classList.remove('show'));
    document.querySelectorAll('.loading').forEach(el => el.classList.remove('show'));
    document.querySelectorAll('.domain-info').forEach(el => el.classList.remove('show'));
}

function showRegisterForm() {
    window.location.replace('?v=register');
}

function showHelp() {
    alert('Help & Support\n\nFor assistance, please contact your system administrator or refer to the documentation.');
}

function checkExistingAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const currentRoute = urlParams.get('v');
    
    // Don't check if we're already on dashboard or register
    if (currentRoute === 'dashboard' || currentRoute === 'register') {
        return;
    }
    
    const token = sessionStorage.getItem('authToken');
    
    if (token) {
        console.log('Found existing token, redirecting to dashboard');
        window.location.replace('?v=dashboard');
    }
}

function clearStoredAuth() {
    sessionStorage.clear();
    localStorage.clear();
}
</script>
</body>

</html>