<script>
  /**
   * Modern UI Framework - Interactive Components
   * Provides modern JavaScript functionality for the UI components
   * 
   * COMPATIBLE WITH APPS SCRIPT V8 RUNTIME
   */
  
  function ModernUI() {
    this.theme = this.getStoredTheme() || 'light';
    this.toasts = [];
    this.modals = [];
    this.autoSaveTimeouts = {};
    this.init();
  }
  
  // Prototype methods for Apps Script compatibility
  
  ModernUI.prototype.init = function() {
    this.setupTheme();
    this.setupEventListeners();
    this.setupToastContainer();
    this.setupModals();
    this.setupFormValidation();
    this.setupAccessibility();
  };
  
  ModernUI.prototype.getStoredTheme = function() {
    return localStorage.getItem('ui-theme');
  };
  
  ModernUI.prototype.storeTheme = function(theme) {
    localStorage.setItem('ui-theme', theme);
  };
  
  ModernUI.prototype.setupTheme = function() {
    document.documentElement.setAttribute('data-theme', this.theme);
    this.updateThemeToggle();
  };
  
  ModernUI.prototype.toggleTheme = function() {
    this.theme = this.theme === 'light' ? 'dark' : 'light';
    this.setupTheme();
    this.storeTheme(this.theme);
  };
  
  ModernUI.prototype.updateThemeToggle = function() {
    var themeToggle = document.querySelector('[data-theme-toggle]');
    if (themeToggle) {
      var icon = themeToggle.querySelector('i, svg');
      if (icon) {
        icon.textContent = this.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      }
    }
  };
  
  ModernUI.prototype.setupEventListeners = function() {
    var self = this;
    // Theme toggle
    document.addEventListener('click', function(e) {
      if (e.target.closest('[data-theme-toggle]')) {
        e.preventDefault();
        self.toggleTheme();
      }
    });
    
    // Modal backdrop clicks
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal-backdrop')) {
        self.closeModal(e.target.dataset.modal);
      }
    });
    
    // ESC key for modals
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        self.closeAllModals();
      }
    });
    
    // Form submissions
    document.addEventListener('submit', function(e) {
      if (e.target.classList.contains('needs-validation')) {
        e.preventDefault();
        self.validateForm(e.target);
      }
    });
  };
  
  ModernUI.prototype.setupToastContainer = function() {
    if (!document.querySelector('.toast-container')) {
      var container = document.createElement('div');
      container.className = 'toast-container';
      document.body.appendChild(container);
    }
  };
  
  ModernUI.prototype.showToast = function(message, type, duration) {
    type = type || 'info';
    duration = duration || 5000;
    
    var container = document.querySelector('.toast-container');
    var toast = document.createElement('div');
    var toastId = 'toast-' + Date.now();
    
    toast.className = 'toast toast-' + type;
    toast.id = toastId;
    toast.innerHTML = '<div class="toast-header"><div class="toast-title">' + this.getToastTitle(type) + '</div><button class="toast-close" data-toast-close="' + toastId + '">√ó</button></div><div class="toast-body">' + message + '</div>';
    
    container.appendChild(toast);
    this.toasts.push(toastId);
    
    var self = this;
    setTimeout(function() { toast.classList.add('show'); }, 100);
    setTimeout(function() { self.removeToast(toastId); }, duration);
    
    toast.querySelector('[data-toast-close="' + toastId + '"]').addEventListener('click', function() {
      self.removeToast(toastId);
    });
    
    return toastId;
  };
  
  ModernUI.prototype.removeToast = function(toastId) {
    var toast = document.getElementById(toastId);
    var self = this;
    if (toast) {
      toast.classList.remove('show');
      setTimeout(function() {
        toast.remove();
        self.toasts = self.toasts.filter(function(id) { return id !== toastId; });
      }, 250);
    }
  };
  
  ModernUI.prototype.getToastTitle = function(type) {
    var titles = {
      success: 'Success',
      warning: 'Warning',
      error: 'Error',
      info: 'Information'
    };
    return titles[type] || 'Notification';
  };
  
  ModernUI.prototype.setupModals = function() {
    var self = this;
    document.querySelectorAll('.modal').forEach(function(modal) {
      self.setupModal(modal);
    });
  };
  
  ModernUI.prototype.setupModal = function(modal) {
    var modalId = modal.id || 'modal-' + Date.now();
    modal.id = modalId;
    
    var self = this;
    var closeBtn = modal.querySelector('.modal-close');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() { self.closeModal(modalId); });
    }
    
    this.modals.push(modalId);
  };
  
  ModernUI.prototype.showModal = function(modalId) {
    var modal = document.getElementById(modalId);
    if (!modal) return;
    
    var backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    backdrop.dataset.modal = modalId;
    
    document.body.appendChild(backdrop);
    document.body.classList.add('modal-open');
    
    setTimeout(function() {
      backdrop.classList.add('show');
      modal.classList.add('show');
    }, 10);
    
    var firstInput = modal.querySelector('input, textarea, select, button');
    if (firstInput) {
      setTimeout(function() { firstInput.focus(); }, 100);
    }
  };
  
  ModernUI.prototype.closeModal = function(modalId) {
    var modal = document.getElementById(modalId);
    var backdrop = document.querySelector('[data-modal="' + modalId + '"]');
    
    if (!modal) return;
    
    modal.classList.remove('show');
    if (backdrop) {
      backdrop.classList.remove('show');
      setTimeout(function() { 
        backdrop.remove();
        // Remove modal from DOM after animation
        setTimeout(function() {
          modal.remove();
        }, 50);
      }, 250);
    } else {
      // If no backdrop, just remove modal immediately
      setTimeout(function() {
        modal.remove();
      }, 250);
    }
    
    document.body.classList.remove('modal-open');
    
    // Remove from modals array
    var index = this.modals.indexOf(modalId);
    if (index > -1) {
      this.modals.splice(index, 1);
    }
  };
  
  ModernUI.prototype.closeAllModals = function() {
    var self = this;
    this.modals.forEach(function(modalId) {
      self.closeModal(modalId);
    });
  };
  
  ModernUI.prototype.createConfigModal = function(categoryKey, categoryData, userEmail) {
    var self = this;
    console.log('Creating config modal for:', categoryKey);
    
    // Close any existing modals before creating a new one
    this.closeAllModals();
    
    // Check if modal already exists for this category
    var modalId = 'config-modal-' + categoryKey;
    var existingModal = document.getElementById(modalId);
    if (existingModal) {
      // Remove existing modal if found
      existingModal.remove();
    }
    
    // Check if this category is read-only
    var isReadOnly = categoryData.isReadOnly || false;
    
    // Create modal HTML
    var modalHTML = '<div class="modal" id="' + modalId + '">' +
      '<div class="modal-content">' +
      '<div class="modal-header">' +
      '<h2>' + (categoryData.icon || '‚öôÔ∏è') + ' ' + (categoryData.name || 'Configuration') + '</h2>' +
      '<button class="modal-close" onclick="window.modernUI.closeModal(\'' + modalId + '\')">√ó</button>' +
      '</div>' +
      '<div class="modal-body">' +
      '<p style="color: #666; margin-bottom: 20px;">' + (categoryData.description || '') + 
      (isReadOnly ? '<br><span style="color: #ff9800; font-size: 0.9em;">‚ö†Ô∏è You have view-only access to this configuration.</span>' : '') + '</p>' +
      '<div class="form-group">' +
      '<label class="form-label">Configuration Settings</label>' +
      '<div class="dashboard-settings-list">';
    
    // Add settings as editable or read-only form fields
    if (categoryData.settings && categoryData.settings.length > 0) {
      modalHTML += '<form id="config-form-' + categoryKey + '">';
      
      modalHTML += categoryData.settings.map(function(setting, index) {
        var key = setting.key || setting;
        var label = setting.label || key;
        var value = setting.value !== undefined ? setting.value : '';
        var inputId = 'setting-' + categoryKey + '-' + index;
        
        // Skip hidden fields
        if (setting.hidden) {
          return '';
        }
        
        // Handle conditional display
        var conditionalClass = '';
        if (setting.conditional) {
          // Store conditional expression in a data attribute
          conditionalClass = ' conditional-field';
        }
        
        // Add disabled attribute if read-only
        var disabledAttr = isReadOnly ? ' disabled' : '';
        var readonlyClass = isReadOnly ? ' form-input-readonly' : '';
        
        var fieldHTML = '<div class="form-group' + conditionalClass + '" data-setting-key="' + key + '"';
        if (setting.conditional) {
          // Escape quotes in conditional for HTML attribute
          var escapedConditional = setting.conditional.replace(/"/g, '&quot;');
          fieldHTML += ' data-conditional="' + escapedConditional + '"';
        }
        fieldHTML += '>';
        fieldHTML += '<label for="' + inputId + '" class="form-label" style="display: block; margin-bottom: 6px; font-weight: 500;">' + label + '</label>';
        
        // Handle select dropdown with options
        if (setting.type === 'select' && setting.options) {
          fieldHTML += '<select id="' + inputId + '" name="' + key + '" class="form-select' + readonlyClass + '"' + disabledAttr + '>';
          setting.options.forEach(function(option) {
            var isSelected = (value === option.value) ? ' selected' : '';
            fieldHTML += '<option value="' + option.value + '"' + isSelected + '>' + option.label + '</option>';
          });
          fieldHTML += '</select>';
        }
        // Array input - comma-separated text
        else if (Array.isArray(value)) {
          fieldHTML += '<input type="text" id="' + inputId + '" name="' + key + '" class="form-input' + readonlyClass + '" value="' + value.join(', ') + '" placeholder="e.g., value1, value2, value2"' + disabledAttr + '>';
        }
        // Boolean - checkbox
        else if (typeof value === 'boolean') {
          fieldHTML += '<select id="' + inputId + '" name="' + key + '" class="form-select' + readonlyClass + '"' + disabledAttr + '>';
          fieldHTML += '<option value="true"' + (value === true ? ' selected' : '') + '>Enabled</option>';
          fieldHTML += '<option value="false"' + (value === false ? ' selected' : '') + '>Disabled</option>';
          fieldHTML += '</select>';
        }
        // Number input
        else if (typeof value === 'number') {
          // Set appropriate min/max based on field type
          var minVal = '0';
          var maxVal = '23'; // Default for hour fields
          if (key === 'maxRunsPerDay') {
            minVal = '2';
            maxVal = '8';
          } else if (key === 'startHour' || key === 'stopHour') {
            minVal = '0';
            maxVal = '23';
          }
          fieldHTML += '<input type="number" id="' + inputId + '" name="' + key + '" class="form-input' + readonlyClass + '" value="' + value + '" min="' + minVal + '" max="' + maxVal + '"' + disabledAttr + '>';
        }
        // Text input
        else {
          fieldHTML += '<input type="text" id="' + inputId + '" name="' + key + '" class="form-input' + readonlyClass + '" value="' + (value || '') + '"' + disabledAttr + '>';
        }
        
        // Add info message if present
        if (setting.info) {
          fieldHTML += '<div class="info-message" style="color: #666; font-size: 0.85em; margin-top: 4px;">‚ÑπÔ∏è ' + setting.info + '</div>';
        }
        // For conditional fields, add an empty placeholder that will be populated by JavaScript
        if (setting.conditional && !setting.info) {
          fieldHTML += '<div class="info-message" style="color: #666; font-size: 0.85em; margin-top: 4px;"></div>';
        }
        
        fieldHTML += '</div>';
        return fieldHTML;
      }).join('');
      
      modalHTML += '</form>';
    } else {
      modalHTML += '<p style="color: #999;">No settings configured</p>';
    }
    
    // Footer buttons - hide Save button if read-only
    modalHTML += '</div>' +
      '</div>' +
      '</div>' +
      '<div class="modal-footer">';
    
    if (isReadOnly) {
      // Only show Close button for read-only modals
      modalHTML += '<button type="button" class="btn btn-secondary" onclick="window.modernUI.closeModal(\'' + modalId + '\')" style="width: 100%;">Close</button>';
    } else {
      // Show both Cancel and Save for editable modals
      modalHTML += '<button type="button" class="btn btn-secondary" onclick="window.modernUI.closeModal(\'' + modalId + '\')">Cancel</button>' +
        '<button type="button" class="btn btn-primary" onclick="window.modernUI.saveConfigModal(\'' + modalId + '\', \'' + categoryKey + '\')">Save Changes</button>';
    }
    
    modalHTML += '</div>' +
      '</div>' +
      '</div>';
    
    // Add modal to document
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Track modal
    this.modals.push(modalId);
    
    // Show modal
    this.showModal(modalId);
    
    // Setup conditional field visibility based on trigger mode
    if (categoryKey === 'triggers') {
      this.setupTriggerModeVisibility(modalId);
    }
    
    // Setup summary type toggle logic for notifications
    if (categoryKey === 'notifications') {
      this.setupSummaryTypeToggle(modalId);
    }
    
    return modalId;
  };
  
  ModernUI.prototype.validateConfigField = function(key, value) {
    // Validate based on Configuration entity rules
    if (key === 'folderIds' || key.includes('folderIds')) {
      // Folder IDs should be non-empty array
      if (typeof value === 'string' && value.trim() === '') {
        return { isValid: false, error: 'Folder IDs cannot be empty' };
      }
    }
    
    if (key === 'minutesThreshold') {
      var num = Number(value);
      if (isNaN(num) || num < 1 || num > 1440) {
        return { isValid: false, error: 'Minutes threshold must be between 1 and 1440' };
      }
    }
    
    if (key === 'maxFilesToProcess') {
      var num = Number(value);
      if (isNaN(num) || num < 1 || num > 1000) {
        return { isValid: false, error: 'Max files to process must be between 1 and 1000' };
      }
    }
    
    if (key === 'sleepBetweenRequest') {
      var num = Number(value);
      if (isNaN(num) || num < 100 || num > 60000) {
        return { isValid: false, error: 'Sleep time must be between 100 and 60000 ms' };
      }
    }
    
    if (key === 'startHour' || key === 'stopHour') {
      var num = Number(value);
      if (isNaN(num) || num < 0 || num > 23) {
        return { isValid: false, error: 'Hour must be between 0 and 23' };
      }
    }
    
    if (key === 'maxRunsPerDay') {
      var num = Number(value);
      if (isNaN(num) || num < 1 || num > 24) {
        return { isValid: false, error: 'Max runs per day must be between 1 and 24' };
      }
    }
    
    if (key === 'adminEmails' || key.includes('adminEmails')) {
      // Validate email format (basic check)
      if (typeof value === 'string' && value.includes(',')) {
        var emails = value.split(',').map(function(e) { return e.trim(); });
        for (var i = 0; i < emails.length; i++) {
          if (emails[i] && !emails[i].includes('@')) {
            return { isValid: false, error: 'Invalid email format' };
          }
        }
      } else if (value && typeof value === 'string' && !value.includes('@')) {
        return { isValid: false, error: 'Invalid email format' };
      }
    }
    
    // All validations passed
    return { isValid: true };
  };
  
  ModernUI.prototype.saveConfigModal = function(modalId, categoryKey) {
    var self = this;
    var modal = document.getElementById(modalId);
    if (!modal) return;
    
    var form = document.getElementById('config-form-' + categoryKey);
    if (!form) {
      this.showToast('No form found to save', 'error');
      return;
    }
    
    // Collect and validate form data
    var formData = new FormData(form);
    var changes = {};
    var validationErrors = [];
    
    formData.forEach(function(value, key) {
      // Validate based on field type
      var validation = self.validateConfigField(key, value);
      if (validation.isValid) {
        changes[key] = value;
      } else {
        validationErrors.push(validation.error);
      }
    });
    
    // If validation errors, show them and return
    if (validationErrors.length > 0) {
      this.showToast('Validation errors: ' + validationErrors.join(', '), 'error');
      return;
    }
    
    console.log('Saving configuration changes for ' + categoryKey + ':', changes);
    
    // Call backend to save changes
    google.script.run
      .withSuccessHandler(function(response) {
        console.log('Save response:', response);
        if (response.success) {
          self.closeModal(modalId);
          self.showToast('Configuration saved successfully!', 'success');
          
          // Refresh dashboard data without full page reload
          setTimeout(function() {
            if (window.loadDashboardData) {
              console.log('Refreshing dashboard data...');
              window.loadDashboardData();
            }
          }, 500);
        } else {
          self.showToast('Failed to save: ' + (response.message || 'Unknown error'), 'error');
        }
      })
      .withFailureHandler(function(error) {
        console.error('Save failed:', error);
        self.showToast('Failed to save configuration: ' + error.message, 'error');
      })
      .updateConfiguration(categoryKey, changes);
  };
  
  ModernUI.prototype.setupFormValidation = function() {
    var self = this;
    document.addEventListener('input', function(e) {
      if (e.target.matches('.form-input, .form-textarea, .form-select')) {
        self.validateField(e.target);
      }
    });
  };
  
  ModernUI.prototype.validateForm = function(form) {
    var self = this;
    var fields = form.querySelectorAll('.form-input, .form-textarea, .form-select');
    var isValid = true;
    
    fields.forEach(function(field) {
      if (!self.validateField(field)) {
        isValid = false;
      }
    });
    
    if (isValid) {
      this.showToast('Form submitted successfully!', 'success');
      this.submitForm(form);
    } else {
      this.showToast('Please fix the errors before submitting.', 'error');
    }
    
    return isValid;
  };
  
  ModernUI.prototype.validateField = function(field) {
    var value = field.value.trim();
    var rules = this.getValidationRules(field);
    var isValid = true;
    var errorMessage = '';
    
    if (rules.required && !value) {
      isValid = false;
      errorMessage = 'This field is required.';
    }
    
    if (rules.email && value && !this.isValidEmail(value)) {
      isValid = false;
      errorMessage = 'Please enter a valid email address.';
    }
    
    if (rules.minLength && value.length < rules.minLength) {
      isValid = false;
      errorMessage = 'Minimum ' + rules.minLength + ' characters required.';
    }
    
    if (rules.maxLength && value.length > rules.maxLength) {
      isValid = false;
      errorMessage = 'Maximum ' + rules.maxLength + ' characters allowed.';
    }
    
    if (rules.pattern && value && !rules.pattern.test(value)) {
      isValid = false;
      errorMessage = rules.patternMessage || 'Invalid format.';
    }
    
    this.updateFieldState(field, isValid, errorMessage);
    return isValid;
  };
  
  ModernUI.prototype.getValidationRules = function(field) {
    return {
      required: field.hasAttribute('required'),
      email: field.type === 'email',
      minLength: parseInt(field.dataset.minLength) || null,
      maxLength: parseInt(field.dataset.maxLength) || null,
      pattern: field.dataset.pattern ? new RegExp(field.dataset.pattern) : null,
      patternMessage: field.dataset.patternMessage || null
    };
  };
  
  ModernUI.prototype.updateFieldState = function(field, isValid, errorMessage) {
    var formGroup = field.closest('.form-group');
    if (!formGroup) return;
    
    var existingError = formGroup.querySelector('.form-error');
    if (existingError) {
      existingError.remove();
    }
    
    field.classList.remove('is-valid', 'is-invalid');
    field.classList.add(isValid ? 'is-valid' : 'is-invalid');
    
    if (!isValid && errorMessage) {
      var errorDiv = document.createElement('div');
      errorDiv.className = 'form-error';
      errorDiv.textContent = errorMessage;
      formGroup.appendChild(errorDiv);
    }
  };
  
  ModernUI.prototype.isValidEmail = function(email) {
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  };
  
  ModernUI.prototype.submitForm = function(form) {
    var formData = new FormData(form);
    var data = {};
    for (var pair of formData.entries()) {
      data[pair[0]] = pair[1];
    }
    
    var self = this;
    var submitBtn = form.querySelector('button[type="submit"]');
    var originalText = submitBtn ? submitBtn.textContent : '';
    
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> Submitting...';
    }
    
    this.simulateApiCall(data).then(function() {
      self.showToast('Form submitted successfully!', 'success');
      form.reset();
    }).catch(function(error) {
      self.showToast('Failed to submit form. Please try again.', 'error');
    }).finally(function() {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  };
  
  ModernUI.prototype.simulateApiCall = function(data) {
    var self = this;
    return new Promise(function(resolve, reject) {
      setTimeout(function() {
        if (Math.random() > 0.1) {
          resolve(data);
        } else {
          reject(new Error('Simulated API error'));
        }
      }, 2000);
    });
  };
  
  ModernUI.prototype.setupSummaryTypeToggle = function(modalId) {
    var self = this;
    var modal = document.getElementById(modalId);
    if (!modal) return;
    
    // Find the summaryType select
    var summaryTypeSelect = modal.querySelector('select[name="summaryType"]');
    if (!summaryTypeSelect) return;
    
    // Function to update summary type
    var updateSummaryType = function() {
      var summaryType = summaryTypeSelect.value;
      console.log('Summary type changed to:', summaryType);
      
      // Find the hidden fields
      var dailySummaryInput = modal.querySelector('input[name="dailySummaryEnabled"]');
      var weeklySummaryInput = modal.querySelector('input[name="weeklySummaryEnabled"]');
      
      if (summaryType === 'daily') {
        // Enable daily, disable weekly
        if (dailySummaryInput) {
          dailySummaryInput.closest('.form-group').style.display = '';
        }
        if (weeklySummaryInput) {
          weeklySummaryInput.value = 'false';
        }
      } else if (summaryType === 'weekly') {
        // Enable weekly, disable daily
        if (weeklySummaryInput) {
          weeklySummaryInput.value = 'true';
        }
        if (dailySummaryInput) {
          dailySummaryInput.value = 'false';
        }
      }
    };
    
    // Initial update
    updateSummaryType();
    
    // Listen for changes to summary type
    summaryTypeSelect.addEventListener('change', updateSummaryType);
  };
  
  ModernUI.prototype.setupTriggerModeVisibility = function(modalId) {
    var self = this;
    var modal = document.getElementById(modalId);
    if (!modal) return;
    
    // Find the triggerMode select
    var triggerModeSelect = modal.querySelector('select[name="triggerMode"]');
    if (!triggerModeSelect) return;
    
    // Function to update field visibility
    var updateFieldVisibility = function() {
      var triggerMode = triggerModeSelect.value;
      console.log('Trigger mode changed to:', triggerMode);
      
      // Find all conditional fields
      var conditionalFields = modal.querySelectorAll('.conditional-field');
      console.log('Found', conditionalFields.length, 'conditional fields');
      
      conditionalFields.forEach(function(field) {
        var conditional = field.getAttribute('data-conditional');
        var settingKey = field.getAttribute('data-setting-key');
        console.log('Field:', settingKey, 'Conditional:', conditional);
        
        if (!conditional) return;
        
        // Unescape the conditional
        conditional = conditional.replace(/&quot;/g, '"');
        console.log('Unescaped conditional:', conditional);
        
        // Evaluate the conditional
        var show = false;
        if (conditional === 'triggerMode === "time-driven"') {
          show = triggerMode === 'time-driven';
        } else if (conditional === 'triggerMode === "count-driven"') {
          show = triggerMode === 'count-driven';
        }
        
        console.log('Field', settingKey, 'should show:', show);
        
        // Update info messages based on mode (only when field is shown)
        if (settingKey === 'stopHour' && show) {
          var stopHourInput = field.querySelector('input[type="number"]');
          var startHourInput = modal.querySelector('input[name="startHour"]');
          if (stopHourInput && startHourInput && stopHourInput.value && startHourInput.value) {
            var stopHour = parseInt(stopHourInput.value);
            var startHour = parseInt(startHourInput.value);
            var runs = stopHour - startHour;
            if (runs > 0) {
              var infoMsg = field.querySelector('.info-message');
              if (!infoMsg) {
                infoMsg = document.createElement('div');
                infoMsg.className = 'info-message';
                infoMsg.style.cssText = 'color: #666; font-size: 0.85em; margin-top: 4px;';
                field.appendChild(infoMsg);
              }
              infoMsg.textContent = '‚ÑπÔ∏è This will result in ' + runs + ' runs per day';
            }
          }
        } else if (settingKey === 'maxRunsPerDay' && show) {
          var maxRunsInput = field.querySelector('input[type="number"]');
          var startHourInput = modal.querySelector('input[name="startHour"]');
          // Always show the info message for maxRunsPerDay when visible
          if (maxRunsInput && startHourInput) {
            // Get values, using 0 as default if empty
            var maxRuns = parseInt(maxRunsInput.value || maxRunsInput.defaultValue) || 4;
            var startHour = parseInt(startHourInput.value || startHourInput.defaultValue) || 0;
            var windowHours = maxRuns * 0.5;
            var endHour = Math.min(Math.ceil(startHour + windowHours), 24);
            
            // Find or create the info message element
            var infoMsg = field.querySelector('.info-message');
            if (!infoMsg) {
              infoMsg = document.createElement('div');
              infoMsg.className = 'info-message';
              infoMsg.style.cssText = 'color: #666; font-size: 0.85em; margin-top: 4px;';
              field.appendChild(infoMsg);
            }
            
            // Update the message content (replaces text, not append)
            infoMsg.textContent = '‚ÑπÔ∏è Window will be ' + windowHours + ' hours (from ' + startHour + ':00 to ' + endHour + ':00)';
          }
        }
        
        // Show or hide the field
        if (show) {
          field.style.display = '';
        } else {
          field.style.display = 'none';
        }
      });
    };
    
    // Initial update
    updateFieldVisibility();
    
    // Listen for changes to trigger mode dropdown
    triggerModeSelect.addEventListener('change', updateFieldVisibility);
    
    // Also listen for changes to start hour to update calculated values
    var startHourInput = modal.querySelector('input[name="startHour"]');
    if (startHourInput) {
      startHourInput.addEventListener('input', updateFieldVisibility);
    }
    
    var stopHourInput = modal.querySelector('input[name="stopHour"]');
    if (stopHourInput) {
      stopHourInput.addEventListener('input', updateFieldVisibility);
    }
    
    var maxRunsInput = modal.querySelector('input[name="maxRunsPerDay"]');
    if (maxRunsInput) {
      maxRunsInput.addEventListener('input', updateFieldVisibility);
    }
  };
  
  ModernUI.prototype.setupAccessibility = function() {
    this.createSkipLinks();
    this.setupFocusManagement();
    this.setupAriaLabels();
  };
  
  ModernUI.prototype.createSkipLinks = function() {
    // Implementation for skip links
  };
  
  ModernUI.prototype.setupFocusManagement = function() {
    // Implementation for focus management
  };
  
  ModernUI.prototype.setupAriaLabels = function() {
    // Implementation for ARIA labels
  };
  
  // Initialize Modern UI when DOM is loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      window.modernUI = new ModernUI();
    });
  } else {
    window.modernUI = new ModernUI();
  }
</script>

